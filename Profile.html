<!DOCTYPE html>

<link rel="stylesheet" href="index.css">
<link rel="stylesheet" href="profile.css">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<body>
    <form action="mainpage.html">
    <button class="backbutton">Back</button>
</form>
    <center><h3>profile page</h3></center>
    <center><div class="profilediv">
    <section class="profile">
    <h5>current profile picture</h5>
    <img id="profilepicture" class="profileimage" src="images/profile.png">
    
<section class="profilebtndiv">
    <input type="file" id="fileInput" class="upload-input" accept="image/*"/>
    <label tabindex="1" for="fileInput" class="upload-button">   Change  </label>
</section>

<section class="username" tabindex="3">
    <h4 style="margin-top: 20%;"> Change username</h4>
    <input type="text" class="textinput" placeholder="Username">
    <button style="margin-top: 5%;">Change</button>

</section>

<section class="deletediv">
    <button class="deletebtn">Delete account</button>
</section>

</section></center>


</div>
</body>

<script type="module">
    
    function getCookie(name) {
  // Split all cookies into an array
  var cookies = document.cookie.split(';');

  // Loop through the cookies
  for (var i = 0; i < cookies.length; i++) {
    var cookie = cookies[i];

    // Trim leading and trailing spaces
    cookie = cookie.trim();

    // Check if the cookie starts with the name we're looking for
    if (cookie.indexOf(name + '=') === 0) {
      // Extract and return the cookie value
      return cookie.substring(name.length + 1, cookie.length);
    }
  }
}


    const firebaseConfig = {
    apiKey: "AIzaSyDuU0009XmoSpkn1ehmfLzqtKKNQ9NOsys",
    authDomain: "login-system-259fd.firebaseapp.com",
    projectId: "login-system-259fd",
    storageBucket: "login-system-259fd.appspot.com",
    messagingSenderId: "723301353539",
    appId: "1:723301353539:web:41754ed85876c50d9a2cf6",
    measurementId: "G-F09GE2SHLZ"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

// Get a reference to the Firebase database
const database = firebase.database();


    var fileupload = document.getElementById("fileInput");
    var profilepic = document.getElementById("profilepicture");

    var dataRef = database.ref('users/' + getCookie("username"))

    async function uploadToImgur(imageFile) {
  try {
    const formData = new FormData();
    formData.append('image', imageFile);

    const response = await fetch('https://api.imgur.com/3/image', {
      method: 'POST',
      headers: {
        Authorization: "Client-ID 7918f28944dd9b6"
      },
      body: formData
    });

    const data = await response.json();
    return data.data.link;
  } catch (error) {
    console.error('Error uploading image to Imgur:', error);
    return null;
  }
}

async function uploadImage(image) {
  var head = new Headers();
  head.append("Authorization", "Client-ID 7918f28944dd9b6");

  const formData = new FormData();
  formData.append("image", image);

  var result = "";

  var requestOpt = {
    method: "POST",
    headers: head,
    body: formData,
    redirect: "follow"
  };

  fetch("https://api.imgur.com/3/image", requestOpt)
  .then(response => response.text)
  .then(result = console.log(result))
  .catch(error => console.log("error", error));


}

    dataRef.once("value", function(snapshot) {
        if (snapshot.profilepic != null) {
            profilepic.src = profilepic;
        }

    })

    function updateValueInDatabase(path, value) {
  database.ref(path).set(value)
    .then(() => {
      console.log('Value updated successfully!');
    })
    .catch((error) => {
      console.error('Error updating value:', error);
    });
}


    async function uploadpic(imageupload) {
      var imgurLink = "";
        imgurLink = await uploadImage(imageupload);
        if (imgurLink) {
          console.log('Image uploaded to Imgur:', imgurLink);
          // Display the link to the user
          alert(`Image uploaded successfully!\n\nImgur link: ${imgurLink}`);
        } else {
          console.log('Image upload failed.');
          alert('Image upload failed. Please try again.');
        }
    
    }


      fileupload.addEventListener("change", function() {
        
    var file = fileupload.files[0];
        console.log("change");

    if (file.size > 20000000) {
      alert("Image size is too big, please choose a image thats under 20MB");
      file = null;
      return;
    }
    uploadpic(file);

    

    const fileread = new FileReader();
    fileread.readAsDataURL(file);
    console.log("done");
    fileread.addEventListener("load", function() {
        profilepic.src = this.result;
    })

  });
</script>